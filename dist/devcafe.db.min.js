/*! DevCafÃ© DB - v0.1.0 - 2012-09-05
* https://github.com/rutkoski/devcafe.db
* Copyright (c) 2012 Rodrigo Rutkoski Rodrigues; Licensed MIT, GPL */
(function(e,t){function n(e){return!isNaN(parseFloat(e))&&isFinite(e)}function r(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function i(e){return Object.prototype.toString.call(e)==="[object Array]"}Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,n=Number(arguments[1])||0;n=n<0?Math.ceil(n):Math.floor(n),n<0&&(n+=t);for(;n<t;n++)if(n in this&&this[n]===e)return n;return-1}),BoolExpr={parse:function(e){function t(e,n){typeof n=="undefined"&&(n=!0);if(!(e+"").length)return"";if(!i(e))return e;var r=e.length;if(r==1)return t(e[0],!n);for(var o=0;o<r;o++)e[o]=t(e[o],!n);return s="("+e.join(n?" AND ":" OR ")+")",s}return t(e)}};var o={query:function(e){return o.factoryQueryObject().sql(e)},insert:function(e,t){return o.factoryQueryObject().insert(e,t)},update:function(e,t,n){return o.factoryQueryObject().update(e,t,n)},remove:function(e,t){return o.factoryQueryObject().remove(e,t)},factoryQueryObject:function(){return new QueryObject},quote:function(e){return n(e)?e:"'"+e+"'"},sqlQuote:function(e){return"`"+e+"`"}};QueryObject=function(){function e(e,t,n){if(t===!0)return s[e];if(t===!1)s[e]=[];else{i(t)||(t=[t]);var r,a=t.length;for(var f=0;f<a;f++){if(typeof t[f]=="undefined")continue;n===!0?(r=s[e].indexOf(t[f]))>-1&&s[e].splice(r,1):(r=s[e].indexOf(t[f]))===-1&&s[e].push(t[f])}}return o="",u}function t(e){return(n&e)==n}var n=QueryObject.SELECT,s={sql:[],data:{},tables:[],fields:[],joins:[],groupBy:[],having:[],where:[],orderBy:[],limit:null,offset:null,alias:null},o="",u={insert:function(e,t){return n=QueryObject.INSERT,u.from(e).data(t)},update:function(e,t,r){return n=QueryObject.UPDATE,u.from(e).data(t).where(r)},remove:function(e,t){return n=QueryObject.DELETE,u.from(e).where(t)},sql:function(e){return n=QueryObject.SELECT,e===!0?s.sql:(e===!1?s.sql=null:s.sql=e,o="",u)},alias:function(e){return e===!0?s.alias:(e===!1?s.alias=null:s.alias=e,u)},data:function(e){return e===!0?s.data:(e===!1?s.data={}:s.data=e,u)},from:function(t,n){return e("tables",t,n)},select:function(t,n){return e("fields",t,n)},leftJoin:function(t,n){return e("joins",[t,"LEFT JOIN"],n)},rightJoin:function(t,n){return e("joins",[t,"RIGHT JOIN"],n)},innerJoin:function(t,n){return e("joins",[t,"INNER JOIN"],n)},groupBy:function(t,n){return e("groupBy",t,n)},having:function(t,n){return e("having",t,n)},where:function(t,n){return e("where",t,n)},orderBy:function(t,n){return e("groupBy",t,n)},limit:function(e){return e===!0?s.limit:(e===!1?s.limit=null:s.limit=e,o="",u)},offset:function(e){return e===!0?s.offset:(e===!1?s.offset=null:s.offset=e,o="",u)},buildQuery:function(){if(!o.length){var e=[];t(QueryObject.SELECT)?(e.push("SELECT"),s.fields.length?e.push(s.fields.join(", ")):e.push("*"),e.push("FROM")):t(QueryObject.INSERT)?e.push("INSERT INTO"):t(QueryObject.UPDATE)?e.push("UPDATE"):t(QueryObject.DELETE)&&e.push("DELETE FROM");if(!s.tables.length)throw new Error("Missing table in expression");e.push(s.tables.join(", ")),t(QueryObject.UPDATE)&&!r(s.data)?e.push("SET ".QueryObject.buildUpdate(s.data)):t(QueryObject.INSERT)&&!r(s.data)&&e.push(QueryObject.buildInsert(s.data));if(t(QueryObject.SELECT)&&s.joins.length)for(var n in s.joins)e.push(s.joins[n][1]+" "+s.joins[n][0]);t(QueryObject.ALL^QueryObject.INSERT)&&s.where.length&&(e.push("WHERE"),e.push(BoolExpr.parse(s.where))),t(QueryObject.SELECT)&&s.groupBy.length&&(e.push("GROUP BY"),e.push(s.groupBy.join(", ")),s.having.length&&e.push(BoolExpr.parse(s.having))),t(QueryObject.ALL^QueryObject.INSERT)&&s.orderBy.length&&(e.push("ORDER BY"),e.push(s.orderBy.join(", "))),s.limit!==null&&(e.push("LIMIT"),e.push(s.limit)),s.offset!==null&&(e.push("OFFSET"),e.push(s.offset)),o=e.join(" "),t(QueryObject.SELECT)&&s.alias&&(o="("+o+") "+s.alias)}return o}};return u},QueryObject.buildIn=function(e,t,n){if(!t.length)return" TRUE ";i(t)||(t=[t]);for(var r in t)t[r]=o.quote(t[r]);s=o.sqlQuote(e);var u=t.join(", ");return t.length>1?s=s+(n?" NOT ":"")+" IN ("+u+")":s=s+(n?" !":" ")+"= "+u,s},QueryObject.buildInsert=function(e,t){typeof t=="undefined"&&(t=!1),fields=[],values=[];for(var n in e){var r=e[n];fields.push(o.sqlQuote(n)),t===!1?values.push(o.quote(r)):typeof t=="string"?values.push(t):values.push(":"+n)}return"("+fields.join(", ")+") VALUES ("+values.join(", ")+")"},QueryObject.buildUpdate=function(e,t){typeof t=="undefined"&&(t=!1),fields=[];for(var n in e){var r=e[n];t===!1?(r=o.quote(r),fields.push(o.sqlQuote(n)+" = "+r)):typeof t=="string"?fields.push(o.sqlQuote(n)+" = "+t):fields.push(o.sqlQuote(n)+" = :"+n)}return fields.join(", ")},QueryObject.SELECT=1,QueryObject.UPDATE=2,QueryObject.INSERT=4,QueryObject.DELETE=8,QueryObject.ALL=15,typeof define=="function"&&define.amd?(define("DB",[],function(){return o}),define("BoolExpr",[],function(){return BoolExpr}),define("QueryObject",[],function(){return QueryObject})):(e.DB=o,e.BoolExpr=BoolExpr,e.QueryObject=QueryObject)})(this);